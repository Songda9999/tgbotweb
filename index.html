<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>账号验证</title>
  <!-- Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Feather Icons for better iconography -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* Custom Styles */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
    }
    /* Loading Spinner */
    .spinner {
      border: 2px solid rgba(0, 0, 0, 0.1);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border-left-color: #495057;
      animation: spin 1s ease infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Custom Toast Notification Style */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      transform: translateX(0);
      left: auto;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
    }
    #toast.show {
      opacity: 1;
      visibility: visible;
    }
    /* Custom Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .modal-content {
        background: white;
        padding: 24px;
        border-radius: 16px;
        width: 90%;
        max-width: 400px;
        transform: scale(0.95);
        transition: transform 0.3s;
    }
    .modal-overlay.show .modal-content {
        transform: scale(1);
    }
    /* Action button style */
    .action-btn {
        padding: 6px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        background-color: white;
        transition: background-color 0.2s;
    }
    .action-btn:hover {
        background-color: #f9fafb;
    }
    .action-btn-primary {
        background-color: #eff6ff;
        color: #2563eb;
        border-color: #dbeafe;
    }
     .action-btn-primary:hover {
        background-color: #dbeafe;
    }
  </style>
</head>
<body class="text-gray-800">

  <!-- Toast Notification Container -->
  <div id="toast"></div>

  <!-- START: Custom Modal -->
  <div id="custom-modal" class="modal-overlay">
    <div class="modal-content text-center">
      <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
      <p id="modal-message" class="text-gray-600 mb-6"></p>
      <div class="flex justify-center space-x-4">
        <button id="modal-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300">取消</button>
        <button id="modal-confirm-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">确认</button>
      </div>
    </div>
  </div>
  <!-- END: Custom Modal -->

  <div class="container mx-auto max-w-4xl p-4 md:p-8">
    
    <!-- Account Verification Section -->
    <section id="account-verification" class="mb-10">
       <h2 class="text-xl font-semibold mb-4 text-gray-900">账号验证</h2>
       <div class="bg-white p-2 md:p-6 rounded-xl border border-gray-200">
          <!-- Email -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="mail" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">邮箱</h3>
                    <p class="text-sm text-gray-500 mt-1">用于登录、提币、安全设置时使用</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>d****@gmail.com</span>
                </div>
                <button class="action-btn">修改</button>
            </div>
          </div>
          <!-- Phone Number -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="smartphone" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">手机号</h3>
                    <p class="text-sm text-gray-500 mt-1">用于提现、修改密码，安全设置时用以收取验证短信</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>***1467</span>
                </div>
                <div class="space-x-2">
                    <button class="action-btn">修改</button>
                    <button class="action-btn action-btn-primary">验证设定</button>
                </div>
            </div>
          </div>
          <!-- Telegram Verification (Dynamic) -->
          <div id="telegram-row" class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100 cursor-pointer">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="send" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">Telegram 验证</h3>
                    <p class="text-sm text-gray-500 mt-1">用于接收实时通知和提现验证</p>
                </div>
            </div>
            <div id="telegram-section" class="flex items-center space-x-6 w-full md:w-auto justify-end">
              <!-- Status will be dynamically filled by JS -->
            </div>
          </div>
          <!-- Google Authenticator -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="shield" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">谷歌验证码</h3>
                    <p class="text-sm text-gray-500 mt-1">用于提现、修改密码，安全设置时用以收取验证短信</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>已设置</span>
                </div>
                <button class="action-btn action-btn-primary">验证设定</button>
            </div>
          </div>
          <!-- Identity Verification -->
          <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="user" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">身份认证</h3>
                    <p class="text-sm text-gray-500 mt-1">完成身份验证，享有最优级的身份权益</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-orange-500 text-sm font-medium">
                     <i data-feather="alert-circle" class="w-4 h-4 mr-2"></i>
                     <span>请重新认证 L2</span>
                </div>
                <button class="action-btn action-btn-primary">查看权益</button>
            </div>
          </div>
          <!-- Nationality -->
          <div class="flex flex-wrap items-center justify-between py-5">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="globe" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">国籍</h3>
                    <p class="text-sm text-gray-500 mt-1">您所使用的功能将受到国籍影响</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>其他地区</span>
                </div>
            </div>
          </div>
       </div>
    </section>

    <!-- Password Section -->
    <section id="password">
      <h2 class="text-xl font-semibold mb-4 text-gray-900">密码</h2>
      <div class="bg-white p-2 md:p-6 rounded-xl border border-gray-200">
        <!-- Login Password -->
        <div class="flex flex-wrap items-center justify-between py-5 border-b border-gray-100">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="lock" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">登录密码</h3>
                    <p class="text-sm text-gray-500 mt-1">请妥善保管您的登录密码</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <span class="text-sm text-gray-500">l**</span>
                <button class="action-btn">修改</button>
            </div>
        </div>
        <!-- Fund Password -->
        <div class="flex flex-wrap items-center justify-between py-5">
            <div class="flex items-center mb-3 md:mb-0">
                <i data-feather="credit-card" class="w-6 h-6 text-gray-400 mr-4"></i>
                <div>
                    <h3 class="text-base font-medium">资金密码</h3>
                    <p class="text-sm text-gray-500 mt-1">为确保您的资金安全请设置资金密码</p>
                </div>
            </div>
            <div class="flex items-center space-x-6 w-full md:w-auto justify-end">
                <div class="flex items-center text-green-600 text-sm font-medium">
                     <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                     <span>已设置</span>
                </div>
                <button class="action-btn">修改</button>
            </div>
        </div>
      </div>
    </section>
  </div>

  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', () => {
        // --- Icon Initialization ---
        feather.replace();

        // =================================================================
        // Configuration
        // =================================================================
        const BOT_USERNAME = "Songdacheckbalance_bot";
        const AUTH_DATA_KEY = 'telegram_auth_data';
        const ACTIVATED_KEY = 'telegram_activated';

        // =================================================================
        // Get DOM Elements
        // =================================================================
        const telegramSection = document.getElementById('telegram-section');
        const telegramRow = document.getElementById('telegram-row');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // =================================================================
        // Modal & Toast Logic (UI Helpers)
        // =================================================================
        let confirmCallback = null;

        function showModal(title, message, confirmText = '确认', cancelText = '取消', onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.textContent = confirmText;
            modalCancelBtn.textContent = cancelText;
            confirmCallback = onConfirm;
            modal.classList.add('show');
        }

        function hideModal() {
            modal.classList.remove('show');
            confirmCallback = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideModal();
        });

        modalCancelBtn.addEventListener('click', hideModal);

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 2500);
        }

        // =================================================================
        // Core Application Logic
        // =================================================================

        function setTelegramUIState(state, userData = null, showActivationModal = false) {
            let statusHTML = '';
            telegramRow.onclick = null;

            let displayName = '';
            if (userData) {
                displayName = userData.username ? `@${userData.username}` : `${userData.first_name}${userData.last_name ? ' ' + userData.last_name : ''}`;
            }
            
            switch (state) {
                case 'unbound':
                    statusHTML = `<button class="action-btn action-btn-primary">绑定</button>`;
                    telegramRow.onclick = bindTelegram;
                    break;
                case 'needs-activation':
                    statusHTML = `
                         <div class="flex items-center text-yellow-500 text-sm font-medium">
                             <i data-feather="alert-circle" class="w-4 h-4 mr-2"></i>
                             <span>待激活</span>
                        </div>
                        <button class="action-btn action-btn-primary">激活</button>
                    `;
                    const activationAction = () => {
                        window.open(`https://t.me/${BOT_USERNAME.replace('@', '')}?start=activate`, '_blank');
                    };
                    telegramRow.onclick = activationAction;
                    
                    if (showActivationModal) {
                        showModal(
                            '需要激活',
                            '绑定成功！请前往 Telegram 完成最后一步验证以激活功能。',
                            '前往激活',
                            '稍后',
                            activationAction
                        );
                    }
                    break;
                case 'activated':
                    statusHTML = `
                        <div class="flex items-center text-green-600 text-sm font-medium">
                             <i data-feather="check-circle" class="w-4 h-4 mr-2"></i>
                             <span>${displayName}</span>
                        </div>
                        <button class="action-btn">解绑</button>
                    `;
                    telegramRow.onclick = unlinkTelegram;
                    break;
                case 'loading':
                    statusHTML = `<div class="spinner"></div>`;
                    break;
            }
            telegramSection.innerHTML = statusHTML;
            feather.replace();
        }

        function bindTelegram() {
          const botId = '8087175912';
          const origin = encodeURIComponent(window.location.origin);
          
          const currentPath = window.location.pathname;
          const directoryPath = currentPath.substring(0, currentPath.lastIndexOf('/'));
          const returnToUrl = `${window.location.origin}${directoryPath}/callback.html`;
          const returnTo = encodeURIComponent(returnToUrl);

          const authUrl = `https://oauth.telegram.org/auth?bot_id=${botId}&origin=${origin}&return_to=${returnTo}&request_access=write&rnd=${Date.now()}`;
          
          window.open(authUrl, 'telegramAuthPopup', 'width=500,height=600');
        }

        function checkAuthStatus(showActivationModal = false) {
            const permanentAuthDataString = localStorage.getItem(AUTH_DATA_KEY);
            if (permanentAuthDataString) {
                const userData = JSON.parse(permanentAuthDataString);
                const isActivated = localStorage.getItem(ACTIVATED_KEY) === 'true';

                if (isActivated) {
                    setTelegramUIState('activated', userData);
                } else {
                    setTelegramUIState('needs-activation', userData, showActivationModal);
                }
            } else {
                setTelegramUIState('unbound');
            }
        }

        function completeActivation() {
            localStorage.setItem(ACTIVATED_KEY, 'true');
            showToast('激活成功！');
            checkAuthStatus();
        }

        function unlinkTelegram() {
            showModal(
                '解除关联',
                '您确定要解除与 Telegram 账户的关联吗？',
                '确定解绑',
                '取消',
                () => {
                    localStorage.removeItem(AUTH_DATA_KEY);
                    localStorage.removeItem(ACTIVATED_KEY);
                    checkAuthStatus();
                    showToast('已解除关联');
                }
            );
        }

        // This is the "messenger" function that the popup will call.
        window.handleTelegramAuth = function(data) {
            if (data && data.success) {
                localStorage.setItem(AUTH_DATA_KEY, JSON.stringify(data.userData));
                localStorage.removeItem(ACTIVATED_KEY); // Reset activation status
                checkAuthStatus(true); // Re-check status and show modal
            } else {
                showToast(data.error || '绑定失败，未知错误。');
            }
        };

        // =================================================================
        // Event Listeners
        // =================================================================
        
        // When user activates in Telegram and comes back, this will trigger.
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                const permanentData = localStorage.getItem(AUTH_DATA_KEY);
                const isActivated = localStorage.getItem(ACTIVATED_KEY) === 'true';
                // If data exists but not activated, we assume they might have just activated.
                if (permanentData && !isActivated) {
                    // This is a simple way to check. A more robust way is a server check.
                    // For now, we'll assume they did it and update the UI.
                    completeActivation();
                }
            }
        });

        // Initial check on page load.
        checkAuthStatus();
    });
  </script>
window.addEventListener('message', (event) => {
  if (event.data && event.data.type === 'telegram-auth') {
    const data = event.data.data;
    console.log('✅ 收到来自 callback 的消息:', data);
    if (data && data.success) {
      localStorage.setItem('telegram_auth_data', JSON.stringify(data.userData));
      localStorage.removeItem('telegram_activated'); // 可选：第一次绑定清除激活状态
      checkAuthStatus(true); // 更新 UI + 弹激活弹窗
    } else {
      showToast(data.error || '绑定失败，未知错误。');
    }
  }
});
    </script>
</body>
</html>
